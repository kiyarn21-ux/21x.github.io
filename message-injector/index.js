(function(v,l,S,C,u,s,M){"use strict";var{FormSection:w,FormInput:E,FormDivider:A,FormRow:_}=S.Forms,D=u.findByStoreName("SelectedChannelStore"),U=u.findByStoreName("UserStore"),MessageStore=u.findByStoreName("MessageStore"),ReadStateStore=u.findByStoreName("ReadStateStore"),b=u.findByProps("dispatch","subscribe");if(!s.storage.senderUserId)s.storage.senderUserId="";if(!s.storage.messageContent)s.storage.messageContent="";if(!s.storage.embedTitle)s.storage.embedTitle="";if(!s.storage.embedDescription)s.storage.embedDescription="";if(!s.storage.embedImageUrl)s.storage.embedImageUrl="";if(!s.storage.customTime)s.storage.customTime="";if(!s.storage.savedMessages)s.storage.savedMessages={};var checkInterval=null;var lastChannel=null;var channelInjectCount={};var origGetLastMessage=null;var patchedGetLastMessage=false;function getTimestamp(customTime){var now=new Date();if(customTime&&customTime.trim()){var parts=customTime.trim().split(":");if(parts.length>=2){var hours=parseInt(parts[0],10);var minutes=parseInt(parts[1],10);if(!isNaN(hours)&&!isNaN(minutes)){now.setHours(hours);now.setMinutes(minutes);now.setSeconds(0);return now.toISOString()}}}now.setMinutes(now.getMinutes()-43);return now.toISOString()}function snowflakeFromTime(timestamp){var epoch=1420070400000;var time=new Date(timestamp).getTime();return String((BigInt(time-epoch)<<BigInt(22)))}function buildMessage(msgId,data){var f=U.getUser(data.senderId);if(!f)return null;var h=[];if(data.embedTitle||data.embedDescription||data.embedImageUrl){var y={type:"rich",color:5793266};if(data.embedTitle)y.title=data.embedTitle;if(data.embedDescription)y.description=data.embedDescription;if(data.embedImageUrl)y.image={url:data.embedImageUrl,proxy_url:data.embedImageUrl};h.push(y)}return{id:msgId,type:0,channel_id:data.channelId,author:{id:f.id,username:f.username,discriminator:f.discriminator||"0",avatar:f.avatar,bot:f.bot||false,global_name:f.globalName||f.username},content:data.content,timestamp:data.timestamp,edited_timestamp:null,tts:false,mention_everyone:false,mentions:[],mention_roles:[],attachments:[],embeds:h,pinned:false,flags:0}}function getLatestFakeForChannel(channelId){var saved=s.storage.savedMessages||{};var latest=null;var latestTime=0;Object.keys(saved).forEach(function(key){var data=saved[key];if(data&&data.channelId===channelId){var t=new Date(data.timestamp).getTime();if(t>latestTime){latestTime=t;latest=data}}});if(latest){return buildMessage(latest.msgId,latest)}return null}function patchMessageStore(){if(patchedGetLastMessage||!MessageStore)return;if(MessageStore.getLastMessage){origGetLastMessage=MessageStore.getLastMessage.bind(MessageStore);MessageStore.getLastMessage=function(channelId){var fake=getLatestFakeForChannel(channelId);var real=origGetLastMessage(channelId);if(fake&&real){var fakeTime=new Date(fake.timestamp).getTime();var realTime=new Date(real.timestamp).getTime();return fakeTime>realTime?fake:real}if(fake)return fake;return real};patchedGetLastMessage=true}}function unpatchMessageStore(){if(origGetLastMessage&&MessageStore){MessageStore.getLastMessage=origGetLastMessage;origGetLastMessage=null;patchedGetLastMessage=false}}function injectForChannel(channelId){var saved=s.storage.savedMessages||{};var msgs=[];Object.keys(saved).forEach(function(key){var data=saved[key];if(data&&data.channelId===channelId){var m=buildMessage(data.msgId,data);if(m)msgs.push(m)}});if(msgs.length>0){b.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:channelId,messages:msgs,isBefore:true,isAfter:false,hasMoreBefore:false,hasMoreAfter:false,truncate:false,jump:undefined,limit:50});return true}return false}function restoreAllChannels(){var saved=s.storage.savedMessages||{};var byChannel={};Object.keys(saved).forEach(function(key){var data=saved[key];if(data&&data.channelId){if(!byChannel[data.channelId])byChannel[data.channelId]=[];byChannel[data.channelId].push(data)}});Object.keys(byChannel).forEach(function(channelId){var msgs=[];byChannel[channelId].forEach(function(data){var m=buildMessage(data.msgId,data);if(m)msgs.push(m)});if(msgs.length>0){b.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:channelId,messages:msgs,isBefore:true,isAfter:false,hasMoreBefore:false,hasMoreAfter:false,truncate:false,jump:undefined,limit:50})}})}function checkAndInject(){patchMessageStore();restoreAllChannels();var currentChannel=D?.getChannelId?.();if(!currentChannel){lastChannel=null;return}if(currentChannel!==lastChannel){lastChannel=currentChannel;channelInjectCount[currentChannel]=0}if(!channelInjectCount[currentChannel])channelInjectCount[currentChannel]=0;if(channelInjectCount[currentChannel]<10){channelInjectCount[currentChannel]++;injectForChannel(currentChannel)}}function I(){var i=s.storage.senderUserId,e=s.storage.messageContent,r=s.storage.embedTitle,a=s.storage.embedDescription,t=s.storage.embedImageUrl,ct=s.storage.customTime;if(!i||!i.trim()){l.ReactNative.Alert.alert("Error","Please enter the Sender User ID!");return}if(!e||!e.trim()){l.ReactNative.Alert.alert("Error","Please enter message content!");return}var n=D?.getChannelId?.();if(!n){l.ReactNative.Alert.alert("Error","No channel selected. Open a DM or channel first!");return}try{var f=U.getUser(i);if(!f){l.ReactNative.Alert.alert("Error","Could not find that user. Make sure the User ID is correct and you share a server with them!");return}var timestamp=getTimestamp(ct);var msgId=snowflakeFromTime(timestamp);var saved=s.storage.savedMessages||{};var key=String(Date.now());saved[key]={senderId:i,content:e,channelId:n,embedTitle:r||"",embedDescription:a||"",embedImageUrl:t||"",timestamp:timestamp,msgId:msgId};s.storage.savedMessages=saved;var m=buildMessage(msgId,saved[key]);if(m){b.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:n,messages:[m],isBefore:true,isAfter:false,hasMoreBefore:false,hasMoreAfter:false,truncate:false,jump:undefined,limit:50})}l.ReactNative.Alert.alert("Success","Fake message injected!")}catch(x){console.error("[Message Injector] Error:",x);l.ReactNative.Alert.alert("Error","Failed: "+(x&&x.message||"Unknown"))}}function restoreAll(){channelInjectCount={};restoreAllChannels();l.ReactNative.Alert.alert("Restored","All messages restored!")}function Q(){var o=U.getCurrentUser();if(!o){l.ReactNative.Alert.alert("Error","Could not get current user!");return}var i=s.storage.senderUserId,e=s.storage.messageContent;s.storage.senderUserId=o.id;s.storage.messageContent="Test message from Message Injector!";I();s.storage.senderUserId=i;s.storage.messageContent=e}function clearAll(){s.storage.savedMessages={};channelInjectCount={};l.ReactNative.Alert.alert("Cleared","All saved messages cleared.")}function F(){C.useProxy(s.storage);var i=s.storage.senderUserId||"",e=s.storage.messageContent||"",r=s.storage.embedTitle||"",a=s.storage.embedDescription||"",t=s.storage.embedImageUrl||"",ct=s.storage.customTime||"",count=Object.keys(s.storage.savedMessages||{}).length;return React.createElement(l.ReactNative.ScrollView,{style:{flex:1}},React.createElement(w,{title:"Message Injector"},React.createElement(l.ReactNative.View,{style:{padding:12,marginBottom:8}},React.createElement(l.ReactNative.Text,{style:{color:"#949ba4",fontSize:14}},"Inject fake messages from any user. Messages persist after restart!"))),React.createElement(w,{title:"Create Fake Message"},React.createElement(E,{title:"From User ID",value:i,onChange:function(n){s.storage.senderUserId=n},placeholder:"User ID of who message is from",keyboardType:"numeric"}),React.createElement(A,null),React.createElement(E,{title:"Message Content",value:e,onChange:function(n){s.storage.messageContent=n},placeholder:"Message text...",multiline:true,numberOfLines:3}),React.createElement(A,null),React.createElement(E,{title:"Message Time (Optional)",value:ct,onChange:function(n){s.storage.customTime=n},placeholder:"HH:MM (e.g. 14:30) - Leave empty for 43min ago"}),React.createElement(A,null),React.createElement(E,{title:"Embed Title (Optional)",value:r,onChange:function(n){s.storage.embedTitle=n},placeholder:"Embed title"}),React.createElement(A,null),React.createElement(E,{title:"Embed Description (Optional)",value:a,onChange:function(n){s.storage.embedDescription=n},placeholder:"Embed description",multiline:true,numberOfLines:2}),React.createElement(A,null),React.createElement(E,{title:"Embed Image URL (Optional)",value:t,onChange:function(n){s.storage.embedImageUrl=n},placeholder:"Image URL"}),React.createElement(A,null),React.createElement(_,{label:"Send Fake Message",subLabel:"Inject into current chat",onPress:I}),React.createElement(A,null),React.createElement(_,{label:"Quick Test",subLabel:"Test message from yourself",onPress:Q})),React.createElement(w,{title:"Saved Messages ("+count+")"},React.createElement(_,{label:"Restore All Now",subLabel:"Re-inject all saved messages",onPress:restoreAll}),React.createElement(A,null),React.createElement(_,{label:"Clear All Saved",subLabel:"Delete all saved messages",onPress:clearAll})))}var P={onLoad:function(){console.log("[Message Injector] Loaded!");channelInjectCount={};patchMessageStore();restoreAllChannels();checkInterval=setInterval(checkAndInject,1)},onUnload:function(){unpatchMessageStore();if(checkInterval)clearInterval(checkInterval);console.log("[Message Injector] Unloaded!")},settings:F};return v.default=P,Object.defineProperty(v,"__esModule",{value:true}),v})({},vendetta.metro.common,vendetta.ui.components,vendetta.storage,vendetta.metro,vendetta.plugin,vendetta.patcher);
